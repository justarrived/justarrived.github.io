#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

cd "$(dirname "$0")/.."

source script/_common

rvm use 2.4.1 --install
script/bootstrap

__exe_cmd "bundle exec jekyll build --config=_config.yml --trace"
if [ ! -d '_site' ]; then
  echo "Jekyll build failed. Missing _site directory (no content to publish)"
  exit 1
fi

REMOTE_REPOSITORY=${REMOTE_REPOSITORY:?'You need to configure the REMOTE_REPOSITORY environment variable!'}
REMOTE_BRANCH=${REMOTE_BRANCH:?'You need to configure the REMOTE_BRANCH environment variable!'}

git config --global user.email "$GIT_USER_EMAIL"
git config --global user.name "$GIT_USER_NAME"

__exe_cmd "ls | grep -v _site | grep -v CNAME | xargs rm -rf" # Remove all files except _site and CNAME
__exe_cmd "cp -r _site/* ."
__exe_cmd "rm -rf _site/"
__exe_cmd "touch .nojekyll"
__exe_cmd "git fetch --unshallow || true" # see https://documentation.codeship.com/general/projects/push-to-remote-repositories/
__exe_cmd "git fetch \"${REMOTE_REPOSITORY}\" \"+refs/heads/*:refs/remotes/origin/*\"" # see https://documentation.codeship.com/general/projects/push-to-remote-repositories/
__exe_cmd "git checkout release"
__exe_cmd "git add --all :/"
__exe_cmd "git commit -m 'compile'"
__exe_cmd "git push -f "${REMOTE_REPOSITORY}" "$(git rev-parse HEAD):${REMOTE_BRANCH}"" # force push the latest commit

echo "Deployed commit: ${CI_COMMIT_ID}"
echo 'deployed: https://justarrived.se'
